<%- include("./partials/header", {title: "Job Detail"}) %>

<section class="py-12 sm:py-16 relative">
  <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
    <div
      class="error-container hidden absolute px-2 py-1 rounded w-[400px] left-2/4 -ml-[200px] bg-red-600 border-red-600 border-2"
    >
      <div class="relative">
        <p class="error-msg text-white"></p>
        <button
          class="close-btn absolute -top-2 -right-2 bg-black text-white text-xs px-1 pb-[2px]"
        >
          Close [x]
        </button>
      </div>
    </div>
    <h1 class="text-3xl font-bold text-white sm:text-4xl lg:text-5xl">
      People
    </h1>
    <p class="mt-2 text-gray-300">Some of the recently created profiles.</p>

    <% if (locals.userId) { %>
    <div
      class="max-w-4xl bg-gray-800 border-[1px] border-gray-700 rounded p-4 mt-8 text-gray-100"
    >
      <h3
        class="font-semibold border-b-[1px] border-gray-500 pb-2 text-gray-300"
      >
        Friend Requests
      </h3>

      <% if (reqsReceived.length === 0) { %>
      <p class="pt-3 max-w-3xl">
        You haven't received any friend requests yet, please check back later.
      </p>
      <% } else { %>
      <ul class="max-w-4xl mt-6">
        <% reqsReceived.forEach(req => { %>
        <li
          class="my-3 border-2 border-gray-700 bg-gray-800 rounded shadow-sm w-full px-5 py-2 flex flex-col sm:flex-row sm:items-center justify-between"
        >
          <div>
            <h3 class="text-lg font-semibold text-gray-100 underline">
              <a href="/social/people/<%= req.requesterId %>">
                <%= req.requester.name %>
              </a>
            </h3>
            <p class="text-sm text-gray-300 break-words my-1">
              <%= req.requester.bio.substring(0, 100) %>...
            </p>
          </div>

          <div class="sm:ml-2 flex flex-row">
            <button
              class="btn-accept btn-primary text-sm rounded px-3 py-1 mr-2"
              data-id="<%= req.id %>"
              data-req-id="<%= req.requesterId%>"
            >
              Accept Request
            </button>
            <button
              class="btn-delete btn-outline text-red-600 border-red-600 hover:bg-red-500 hover:border-white text-sm rounded px-3 py-1"
              data-id="<%= req.id %>"
            >
              Delete Request
            </button>
          </div>
        </li>
        <% }) %>
      </ul>
      <% } %>
    </div>
    <% } %> <% if (people.length === 0) { %>
    <p class="text-lg text-gray-300 text-center mt-5">
      No profiles for now, please check back later.
    </p>
    <% } else { %>
    <ul class="max-w-4xl mt-6">
      <% people.forEach(person => { %>
      <li
        class="my-3 border-2 border-gray-700 bg-gray-800 rounded shadow-sm w-full px-5 py-2 flex flex-col sm:flex-row sm:items-center justify-between"
      >
        <div>
          <h3 class="text-lg font-semibold text-gray-100 underline">
            <a href="/social/people/<%= person.id %>"> <%= person.name %> </a>
          </h3>
          <p class="text-sm text-gray-300 break-words my-1">
            <%= person.bio.substring(0, 100) %>...
          </p>
        </div>

        <div class="sm:ml-2 flex flex-row">
          <% if (locals.userId) { %> <% if (friends.includes(person.id)) { %>
          <button
            class="btn-primary text-sm rounded px-3 py-1 mr-2 opacity-75 bg-blueDark pointer-events-none"
          >
            Friend
          </button>
          <% } else if (pendingReqsIds.includes(person.id)) { %>
          <button
            class="btn-primary text-sm rounded px-3 py-1 mr-2 opacity-75 pointer-events-none"
          >
            Request Sent
          </button>
          <% } else { %>
          <form
            method="post"
            action="/social/people/friend"
            class="inline reqForm"
          >
            <input
              type="text"
              hidden
              value="<%= person.id %>"
              name="personId"
            />
            <button
              class="btn-primary text-sm rounded px-3 py-1 mr-2 disabled:bg-blue-400"
              type="submit"
            >
              Add Friend
            </button>
          </form>
          <% } %> <% } %>
          <a
            href="/social/people/<%= person.id %>"
            class="underline font-bold text-golden text-sm"
            >View Profile</a
          >
        </div>
      </li>
      <% }) %>
    </ul>
    <% } %>
  </div>
</section>

<script>
  const forms = document.querySelectorAll(".reqForm");
  forms.forEach((f) => f.addEventListener("submit", handleSubmit));

  async function handleSubmit(event) {
    const form = event.target;
    event.preventDefault();
    const formData = new FormData(form);
    const personId = formData.get("personId");

    try {
      const res = await fetch("/social/people/friend", {
        method: "POST",
        body: JSON.stringify({ personId }),
        headers: {
          "Content-Type": "application/json",
        },
      });
      const json = await res.json();

      if (json.status === "success") {
        const btn = form.querySelector("button");
        btn.innerText = "Request Sent";
        btn.setAttribute("disabled", "");
      } else if (json.status === "error") {
        const errContainer = document.querySelector(".error-container");
        const errMsg = document.querySelector(".error-msg");

        errContainer.style.display = "block";
        errMsg.innerText = json.message;

        const closeBtn = document.querySelector(".close-btn");
        closeBtn.addEventListener("click", () => {
          errMsg.innerText = "";
          errContainer.style.display = "none";
        });
      }
    } catch (e) {
      console.error(e);
    }
  }

  const acceptBtns = document.querySelectorAll(".btn-accept");
  const deleteBtns = document.querySelectorAll(".btn-delete");

  acceptBtns.forEach((btn) => btn.addEventListener("click", acceptRequest));
  deleteBtns.forEach((btn) => btn.addEventListener("click", deleteRequest));

  async function acceptRequest(event) {
    const requestId = event.target.getAttribute("data-id");
    const requesterId = event.target.getAttribute("data-req-id");

    try {
      const res = await fetch("/social/acceptRequest", {
        method: "POST",
        body: JSON.stringify({ requestId, requesterId }),
        headers: {
          "Content-Type": "application/json",
        },
      });
      const json = await res.json();

      if (json.status === "success") {
        // remove the old buttons and add a new disabled button with updated status
        const parentEl = event.target.parentNode;
        const innerBtns = parentEl.querySelectorAll("button");
        innerBtns.forEach((btn) => btn.remove);

        parentEl.innerHTML =
          '<button class="btn-primary text-sm rounded px-3 py-1" disabled>Friend</button>';
      } else if (json.status === "error") {
        const errContainer = document.querySelector(".error-container");
        const errMsg = document.querySelector(".error-msg");

        errContainer.style.display = "block";
        errMsg.innerText = json.message;

        const closeBtn = document.querySelector(".close-btn");
        closeBtn.addEventListener("click", () => {
          errMsg.innerText = "";
          errContainer.style.display = "none";
        });
      }
    } catch (e) {
      console.error(e);
    }
  }

  async function deleteRequest(event) {
    const requestId = event.target.getAttribute("data-id");

    try {
      const res = await fetch("/social/deleteRequest", {
        method: "DELETE",
        body: JSON.stringify({ requestId }),
        headers: {
          "Content-Type": "application/json",
        },
      });
      const json = await res.json();
      if (json.status === "success") {
        // remove the old buttons and add a new disabled button with updated status
        const parentEl = event.target.parentNode;
        const innerBtns = parentEl.querySelectorAll("button");
        innerBtns.forEach((btn) => btn.remove);

        parentEl.innerHTML =
          '<button class="bg-red-500 text-sm text-white rounded px-3 py-1" disabled>Deleted</button>';
      } else if (json.status === "error") {
        const errContainer = document.querySelector(".error-container");
        const errMsg = document.querySelector(".error-msg");

        errContainer.style.display = "block";
        errMsg.innerText = json.message;

        const closeBtn = document.querySelector(".close-btn");
        closeBtn.addEventListener("click", () => {
          errMsg.innerText = "";
          errContainer.style.display = "none";
        });
      }
    } catch (e) {
      console.error(e);
    }
  }
</script>

<%- include("./partials/footer") %>
